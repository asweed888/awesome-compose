#!/bin/bash

if [ ! -e ./.env ]; then
    cp -f .env.sample .env
fi

if [ ! -e ./compose.d/.dist ]; then
    mkdir ./compose.d/.dist
fi

. .env
rm -f ./compose.d/.dist/*.yml

for namespace in ${NAMESPACES[@]}; do
    ymls=''
    for file in `ls -1 ./compose.d/$namespace/*.yml`; do
        if [ -e ./compose.d/$namespace/value.sh ]; then
            . ./compose.d/$namespace/value.sh
        fi

        dist_path="./compose.d/.dist/${namespace}_${file##*/}"
        envsubst < $file > $dist_path
    done

    for file in `ls -1 ./compose.d/.dist/${namespace}_*.yml`; do
        ymls="-f $PWD/compose.d/.dist/${file##*/} $ymls"
    done

    export COMPOSE_PROJECT_NAME=$namespace
    eval "docker-compose $ymls $@"
done
