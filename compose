#!/bin/bash

if [ ! -e ./.env ]; then
    cp -f .env.sample .env
fi

if [ ! -e ./compose.d/.dist ]; then
    mkdir ./compose.d/.dist
fi

. .env
for line in `cat .env`; do
  eval "export $line"
done
NAMESPACES=(${NAMESPACES//:/ })

rm -f ./compose.d/.dist/*.yml

for namespace in ${NAMESPACES[@]}; do
    ymls=''
    for file in `ls -1 ./compose.d/$namespace/*.yml`; do
        if [ -e ./compose.d/$namespace/.env ]; then
            . ./compose.d/$namespace/.env
            for line in `cat ./compose.d/$namespace/.env`; do
              eval "export $line"
            done
        fi

        dist_path="./compose.d/.dist/${namespace}_${file##*/}"
        envsubst < $file > $dist_path
    done

    for file in `ls -1 ./compose.d/.dist/${namespace}_*.yml`; do
        ymls="-f $PWD/compose.d/.dist/${file##*/} $ymls"
    done

    export COMPOSE_PROJECT_NAME=$namespace
    eval "docker-compose $ymls $@"
done
